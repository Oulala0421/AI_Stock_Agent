name: Test LINE Notification

on:
  workflow_dispatch:

jobs:
  test_line:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests python-dotenv
    
    - name: Check Secrets Availability
      run: |
        echo "ğŸ” æª¢æŸ¥ GitHub Secrets å¯ç”¨æ€§..."
        echo "LINE_TOKEN exists: ${{ secrets.LINE_TOKEN != '' }}"
        echo "LINE_USER_ID exists: ${{ secrets.LINE_USER_ID != '' }}"
        echo "LINE_GROUP_ID exists: ${{ secrets.LINE_GROUP_ID != '' }}"
    
    - name: Debug Environment Variables
      env:
        LINE_TOKEN: ${{ secrets.LINE_TOKEN }}
        LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
        LINE_GROUP_ID: ${{ secrets.LINE_GROUP_ID }}
      run: |
        echo "ğŸ” æª¢æŸ¥ç’°å¢ƒè®Šæ•¸è¼‰å…¥ç‹€æ…‹..."
        [ -z "$LINE_TOKEN" ] && echo "âŒ LINE_TOKEN is EMPTY" || echo "âœ… LINE_TOKEN loaded (${#LINE_TOKEN} chars)"
        [ -z "$LINE_USER_ID" ] && echo "âŒ LINE_USER_ID is EMPTY" || echo "âœ… LINE_USER_ID: $LINE_USER_ID"
        [ -z "$LINE_GROUP_ID" ] && echo "âŒ LINE_GROUP_ID is EMPTY" || echo "âœ… LINE_GROUP_ID: $LINE_GROUP_ID"
    
    - name: Test LINE Bot Info
      env:
        LINE_TOKEN: ${{ secrets.LINE_TOKEN }}
      run: |
        echo "ğŸ¤– æ¸¬è©¦ LINE Bot Token æœ‰æ•ˆæ€§..."
        python -c "
        import requests
        import os
        import sys
        
        token = os.getenv('LINE_TOKEN')
        if not token:
            print('âŒ LINE_TOKEN ç’°å¢ƒè®Šæ•¸æœªè¨­å®š')
            sys.exit(1)
        
        headers = {'Authorization': f'Bearer {token}'}
        r = requests.get('https://api.line.me/v2/bot/info', headers=headers)
        
        if r.status_code == 200:
            info = r.json()
            print(f'âœ… Bot é©—è­‰æˆåŠŸ')
            print(f'   Bot Name: {info.get(\"displayName\", \"N/A\")}')
            print(f'   Bot ID: {info.get(\"userId\", \"N/A\")[:20]}...')
        else:
            print(f'âŒ Bot é©—è­‰å¤±æ•—: HTTP {r.status_code}')
            print(f'   Response: {r.text}')
            sys.exit(1)
        "
    
    - name: Test LINE Message Send
      env:
        LINE_TOKEN: ${{ secrets.LINE_TOKEN }}
        LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
        LINE_GROUP_ID: ${{ secrets.LINE_GROUP_ID }}
      run: |
        echo "ğŸ“¤ æ¸¬è©¦ LINE è¨Šæ¯ç™¼é€..."
        python -c "
        import requests
        import os
        import sys
        from datetime import datetime
        
        token = os.getenv('LINE_TOKEN')
        user_id = os.getenv('LINE_USER_ID')
        group_id = os.getenv('LINE_GROUP_ID')
        
        if not token:
            print('âŒ LINE_TOKEN æœªè¨­å®š')
            sys.exit(1)
        
        headers = {
            'Content-Type': 'application/json',
            'Authorization': f'Bearer {token}'
        }
        
        timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')
        test_message = f'ğŸ§ª GitHub Actions LINE æ¸¬è©¦\næ™‚é–“: {timestamp}\né€™æ˜¯å¾ GitHub Actions ç™¼é€çš„æ¸¬è©¦è¨Šæ¯'
        
        # æ¸¬è©¦ç¾¤çµ„ç™¼é€
        if group_id:
            print(f'ğŸ“Œ æ¸¬è©¦ç¾¤çµ„ç™¼é€ (ID: {group_id[:10]}...)')
            url = 'https://api.line.me/v2/bot/message/push'
            payload = {
                'to': group_id,
                'messages': [{'type': 'text', 'text': test_message}]
            }
            r = requests.post(url, headers=headers, json=payload)
            
            if r.status_code == 200:
                print('âœ… ç¾¤çµ„è¨Šæ¯ç™¼é€æˆåŠŸ')
            else:
                print(f'âŒ ç¾¤çµ„è¨Šæ¯ç™¼é€å¤±æ•—: HTTP {r.status_code}')
                print(f'   Response: {r.text}')
                sys.exit(1)
        else:
            print('âš ï¸ LINE_GROUP_ID æœªè¨­å®šï¼Œè·³éç¾¤çµ„æ¸¬è©¦')
        
        # æ¸¬è©¦å€‹äººç™¼é€
        if user_id:
            print(f'ğŸ“Œ æ¸¬è©¦å€‹äººç™¼é€ (ID: {user_id[:10]}...)')
            url = 'https://api.line.me/v2/bot/message/push'
            payload = {
                'to': user_id,
                'messages': [{'type': 'text', 'text': test_message}]
            }
            r = requests.post(url, headers=headers, json=payload)
            
            if r.status_code == 200:
                print('âœ… å€‹äººè¨Šæ¯ç™¼é€æˆåŠŸ')
            else:
                print(f'âŒ å€‹äººè¨Šæ¯ç™¼é€å¤±æ•—: HTTP {r.status_code}')
                print(f'   Response: {r.text}')
        else:
            print('âš ï¸ LINE_USER_ID æœªè¨­å®šï¼Œè·³éå€‹äººæ¸¬è©¦')
        "
    
    - name: Summary
      if: always()
      run: |
        echo ""
        echo "=========================================="
        echo "âœ… LINE é€šçŸ¥æ¸¬è©¦å®Œæˆ"
        echo "=========================================="
        echo ""
        echo "å¦‚æœä»¥ä¸Šæ‰€æœ‰æ­¥é©Ÿéƒ½æˆåŠŸï¼š"
        echo "  â†’ GitHub Secrets è¨­å®šæ­£ç¢º"
        echo "  â†’ LINE Bot å·²æ­£å¸¸é‹ä½œ"
        echo "  â†’ å¯ä»¥é–‹å§‹ä½¿ç”¨ daily_analysis workflow"
        echo ""
        echo "å¦‚æœæœ‰å¤±æ•—ï¼š"
        echo "  â†’ è«‹æª¢æŸ¥å°æ‡‰æ­¥é©Ÿçš„éŒ¯èª¤è¨Šæ¯"
        echo "  â†’ ç¢ºèª Repository Secrets è¨­å®šæ˜¯å¦æ­£ç¢º"
        echo ""
